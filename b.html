<html>
    <head>
        <script>
/*
    Draw a (digital) clock with a start time specified by the first 
    item in 'timetable'

    time offset is a Global.


    TODO:
        at the start, build an array of "slow-down" and "speed-up" times,
        make sure the timetable is chronological

        I might want to redo the start-time calculations to use times-in
        seconds, rather than relying on string manipulation.
*/

/*
    Times in the timetable must be 'hh:mm:ss'
*/
var timetable = [
    ['09:58:00', '10:03:45'],
    ['10:30:00', '10:33:00']
];
var timeOffset = 0;  // difference between real "now" and fake Clock time
var months = 'Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec'.split(' ');
var clockElementId = '';
var timetable_s = [];  // a 1D array of timetable times.
var timetablePosition = 0;  // indicator of which time step we're looking at
var clockSpeed = 1;  // seconds per second



function getClockTime(offset_secs) {
    var now = new Date(new Date().getTime() - offset_secs*1000);
    var hour = now.getHours();
    var minute = now.getMinutes();
    var second = now.getSeconds();
    return [hour, minute, second];
}


/* zero-pad a value (only intended for numbers up to 60) 6 => 06 */
function padStart(num) {
    return ('0'+num).slice(-2);
}


function drawClock() {
    var hms = getClockTime(timeOffset);
    var h = hms[0], m=hms[1], s=hms[2];
    document.getElementById(clockElementId).innerHTML = 
        padStart(h) + ":" + padStart(m) + ":" + padStart(s);

    // Have we hit a "boundary" time when we need to change speed?
    if ( (h*3600 + m * 60 + s) > timetable_s[timetablePosition]['time'] ) {
        console.log("YOU HAVE HIT A BOUNDARY");
        console.log(timetable_s[timetablePosition]['time'], "<=>", (h*3600 + m * 60 + s) );

    }
}

/*
   Read the initial time from the Timetable and calculate our offset from 
   real time.
*/
function calculateStartOffset() {
    var start = timetable[0][0];
    now = new Date();
    // Use the fact that 'start' is already hh:mm:ss to create a new 
    // Date from a string.
    var fakeDate = now.getDate() + " " + months[now.getMonth()] +
                            " " + now.getFullYear() + " " + start;
    appTimeStart = new Date(fakeDate);
    timeOffset = (now.getTime() - appTimeStart.getTime()) / 1000;

    // we've started; the next time is the first one where we speed up.
    timetablePosition = 1;
}

/*
    Convert a string "hh:mm:ss" into number of seconds.
*/
function convertHhmmssToSeconds(in_str) {
    var parts = in_str.split(':');
    var hours = parseInt(parts[0]) * 3600;
    var minutes = parseInt(parts[1]) * 60;
    var seconds = hours + minutes + parseInt(parts[2]);
    return seconds;
}


/*
    Convert timetable in 'hh:mm:ss' into a timetable in seconds 
    since midnight.
*/
function convertTimetable() {
    var time_str, parts, hours, minutes, seconds;
    var new_tt_index = 0;
    for (var row = 0; row < timetable.length; row++) {
        secs = convertHhmmssToSeconds(timetable[row][0]);
        timetable_s[new_tt_index++] = {'speed': 'normal', 'time': secs};
        secs = convertHhmmssToSeconds(timetable[row][1]);
        timetable_s[new_tt_index++] = {'speed': 'fast', 'time': secs};
    }

    // add a "normal" time on the end.
    timetable_s[new_tt_index++] = {'speed': 'normal', 'time': secs+30};
}


        </script>
    </head>


    <body>
        <p id="digitalclock">
        </p>

        <script>
            clockElementId = 'digitalclock';
          
            convertTimetable()
            calculateStartOffset();
            drawClock();
            setInterval(drawClock, 1000);
        </script>
    </body>
</html>
